# Usage Guide

This guide explains how to run the analysis pipeline safely—especially for the Luraph v14.4.2 payload distributed as `Obfuscated3.lua`. The workflow assumes you are working inside this repository and have already installed Python 3.9+ along with the dependencies listed in `requirements.txt` (or the dev extras).

## Prerequisites

1. **Python environment** – Python 3.9 or newer with virtual environment support.
2. **Dependencies** – Install via `pip install -r requirements.txt` (add `-r requirements-dev.txt` if you plan to run the full test suite).
3. **Lua runtime (optional)** – Some parity checks rely on `lupa`/Lua. If you do not have Lua available, those steps will gracefully skip or fall back to static analysis.
4. **Session key discipline** – Keys must only be supplied at run time through CLI flags or standard input. Never write keys into files, environment variables, version control, or configuration.

## Running the Full Detection Pipeline

The orchestrator `python -m src.tools.run_all_detection` chains the loader, bootstrap extractor, byte extractor, collectors, and reporters. A typical workflow looks like this:

```bash
python -m src.tools.run_all_detection tests/samples/Obfuscated3.lua \
    --out-dir out/run_latest \
    --debug \
    --use-key
```

* Use `--use-key` to signal that a session key will be provided. The script will prompt you to paste the key (e.g., `TINY-1D58EFB7`). The key is consumed in-memory and zeroized after use.
* When running against other files that do not require a key, omit `--use-key`.
* The pipeline writes manifests, detection reports, opcode proposals, and other artefacts under the chosen `--out-dir`. Keys are never persisted.
* Enable `--debug` only when you need additional logging or binary dumps; the option increases verbosity and produces more artefacts for inspection.

### Safe Key Handling

- Provide keys **only** through the CLI prompt (`--use-key`) or via stdin when a tool explicitly requests it (for example, `python -m src.tools.parity_test ... --key -`).
- After the tool consumes the key, it overwrites the buffer to avoid lingering secrets.
- Never store a key inside scripts, configuration, or git-tracked files. The tooling will refuse to save artefacts that include a field named `key` to reduce the risk of leakage.

## Incremental Workflow

1. **Load & Extract** – Run `python -m src.io.loader <file.lua> --out-dir out/loader_run` to normalise the source and capture raw payloads.
2. **Bootstrap Analysis** – `python -m src.bootstrap.extract_bootstrap out/loader_run/raw_manifest.json --out out/bootstrap_candidates.json` identifies candidate bootstrap chunks with confidence scores.
3. **Byte Extraction** – `python -m src.tools.byte_extractor --manifest out/bootstrap_candidates.json --out-dir out/bytes_run` converts snippets into raw byte blobs and records endianness hints.
4. **Collector & Detection** – `python -m src.tools.collector ...` (or the full `run_all_detection` orchestrator) fuses heuristics, mapping detection, and pipeline scoring to produce `out/pipeline_candidates.json` and accompanying reports.
5. **Further Analysis** – Use specialised utilities (opcode proposer, lifter, beautifier, etc.) on the artefacts emitted in the previous step. Each tool respects the no-key-persistence policy.

## Handling Obfuscated3.lua (v14.4.2)

The following checklist is tuned specifically for `Obfuscated3.lua` (Luraph v14.4.2):

1. **Acquire the session key** (for example, `TINY-1D58EFB7`) from a trusted channel. Do not save it.
2. **Run detection** with `--use-key` so the pipeline can access the bootstrap internals. Confirm that the prompt echoes only masked characters and that the key is zeroized afterwards.
3. **Inspect outputs** under `out/`:
   - `out/detection_report.md` summarises payload structure, pipeline confidence, and recommended next steps.
   - `out/opcode_maps/` holds candidate opcode mappings (no keys).
   - `out/ir/` and `out/deobfuscated_pretty.lua` provide lifted and beautified representations for manual review.
4. **Review warnings** in `out/warnings.txt` (if generated by `replace_insecure_patterns`) and `out/recommendations.md` for manual follow-up.
5. **Clean up** temporary directories after inspection if local policy requires removing sensitive artefacts.

Remember: keys must never be committed, logged, or stored in backups. All tooling in this repository is designed to reject artefacts containing the string `"key"`, but you remain responsible for handling secrets properly.

## Additional Resources

- `docs/IR.md` – Detailed description of the intermediate representation produced by the lifter.
- `tests/samples/` – Synthetic Lua samples and pipeline specifications for testing workflows without real secrets.
- `ci/github-actions-ci-runner-example.yml` – Template for CI runs (with placeholders) that demonstrates how to execute the pipeline safely without embedding keys.

Stay vigilant about key hygiene and version-specific nuances, and the tooling will guide you through safe, repeatable analysis sessions.
