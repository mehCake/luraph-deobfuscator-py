# Codex Prompt Templates for Luraph v14.4.x Analysis

This document aggregates ready-to-use prompt templates that analysts can paste into Codex when they need help translating or validating difficult VM handlers. The prompts are designed for the current pipeline layout in this repository and reference concrete artefacts that the detection flow emits.

## Usage guidance

- Run `python -m src.tools.run_all_detection --file tests/samples/Obfuscated3.lua --debug --use-key TINY-XXXXXX` to refresh the artefacts referenced below. Replace `TINY-XXXXXX` with the session key provided for *this session only*.
- Ensure the key is passed only via CLI flags or stdin. **Never** store the key inside repository files, JSON artefacts, or shared logs.
- After completing your Codex interaction, wipe any clipboard or temporary files that contain the session key.

Each template explicitly instructs Codex to avoid persisting keys and to zero any in-memory buffers that hold secret material.

## Quick references

| Artefact | Purpose | Generated by |
| --- | --- | --- |
| `out/pipeline_candidates.json` | Ranked pipeline hypotheses with heuristic scores. | `src/tools/collector.py` |
| `out/opcode_maps/` | Proposed opcode maps (JSON). | `src/vm/opcode_proposer.py`, `src/tools/interactive_map_editor.py` |
| `out/handler_suggestions.json` | Handler signature analysis output. | `src/vm/compare_handlers.py` |
| `out/ir/<candidate>.json` | Lifted IR blocks with metadata. | `src/vm/lifter.py` |
| `out/structured/<candidate>.lua` | Structured pseudo-Lua with offsets. | `src/vm/reconstruct_controlflow.py` |
| `out/final_report.md` | Analyst-focused pipeline summary. | `src/pretty/reporter.py` |
| `out/recommendations.md` | Manual review checklist. | `src/tools/recommendations.py` |

## Prompt template: confirm handler translation (v14.4.2 focus)

```
You are assisting with deobfuscating a Luraph v14.4.2 VM. Using the repository layout from luraph-deobfuscator-py:

- Review the handler body extracted under `out/handler_suggestions.json` for opcode `<OPCODE_ID>`.
- Cross-check opcode metadata in `out/opcode_maps/approved-latest.json` (or the highest-ranked entry in `out/opcode_proposals.json`).
- Examine the lifted IR located at `out/ir/<candidate>.json`, especially block `<BLOCK_ID>` where this opcode appears.
- Compare with the structured pseudo-Lua in `out/structured/<candidate>.lua` to understand control-flow context.

Tasks:
1. Translate the handler into idiomatic Lua pseudocode with register names from `src/pretty/rename_map.py` suggestions.
2. Highlight how stack/register usage aligns with Lua 5.1 semantics (LOADK, MOVE, CALL, RETURN, etc.).
3. Recommend mnemonic adjustments in `out/opcode_maps/approved-latest.json` if the behaviour deviates.

Security constraints:
- Do **not** write any keys to files. Use the session key only from the CLI argument supplied to `run_all_detection` and zero any temporary buffers after use.
- Treat data under `out/opcode_maps/`, `out/ir/`, and `out/structured/` as sensitive; only describe changes to be made.

Respond with a step-by-step reasoning summary plus the final suggested mnemonic.
```

## Prompt template: validate PRGA / LPH configuration

```
The detection pipeline produced candidate PRGA and LPH configurations in `out/pipeline_candidates.json` and `out/transform_profile.json`.

1. Inspect the candidate listed with the highest `confidence_score` in `out/pipeline_candidates.json`.
2. Review intermediate artefacts in `out/intermediate/` dumped by `src/decoders/initv4_prga.py` (debug mode) and `src/decoders/lph_reverse.py`.
3. Use helper functions from `src/tools/hypothesis_scoring.py` to justify why the candidate scores highly (parity checks, Lua token density, English-likeness).
4. Suggest refinements to parameter presets in `src/decoders/lph_reverse.py` or `src/decoders/initv4_prga.py` if mismatches remain.

Security reminder: Do **not** persist the session key. Use it only via `--use-key` CLI options and zero buffers after invoking parity checks.
```

## Prompt template: generate handler translation TODO list

```
We have partially labelled opcode handlers for a Luraph v14.4.2 VM. Reference the following resources:
- Handler heuristics: `out/handler_suggestions.json`
- Opcode proposals: `out/opcode_proposals.json`
- CFG exports: `out/cfg/<candidate>.json`
- Structured control flow: `out/structured/<candidate>.lua`

Produce a prioritized TODO list for human analysts that:
1. Identifies opcodes with low confidence in `out/opcode_proposals.json`.
2. Suggests which IR blocks (`out/ir/<candidate>.json`) to examine first.
3. Notes any traps or opaque predicates flagged in `out/cfg/<candidate>.json`.

Explicitly remind analysts: “Do not write keys to files; use the key only from the provided CLI parameter and zero it after use.”
```

## Prompt template: request Codex assistance for string table decoding

```
Refer to string deobfuscation output under `out/strings/` generated by `src/pretty/string_deobf.py`.

1. Summarize the decoding attempts (Base64/Base85/custom alphabets) for table `<TABLE_NAME>`.
2. Correlate with constant pool recovery data from `out/constants/<candidate>.json`.
3. Suggest next decoding steps or additional heuristics using `src/tools/byte_extractor.py` and `src/tools/fuzzy_param_search.py`.

Add to the prompt: “Do not write keys to files; use key only from provided CLI param and zero it after use.”
```

## Maintaining this document

- Update templates whenever new artefacts (e.g., snapshot diffs from `src/tools/snapshotter.py`) become available.
- Keep instructions specific to the active Luraph version set; adjust file paths if pipeline defaults change.
- Re-run `python -m src.tools.run_all_detection` before copying a template so Codex receives accurate context.

Session key used: none (templates only).
